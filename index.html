<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T·∫°o Quiz Offline</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.8.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>
    <style>
        :root {
            --primary-bg: #f4f6f9; --secondary-bg: #ffffff; --text-color: #212529;
            --primary-color: #007bff; --secondary-color: #6c757d; --success-color: #28a745;
            --danger-color: #dc3545; --border-radius: 8px; --box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        body { font-family: Arial, sans-serif; background-color: var(--primary-bg); color: var(--text-color); margin: 0; padding: 15px; }
        .container { 
            max-width: 800px; 
            margin: auto; 
            background-color: var(--secondary-bg); 
            padding: 20px; 
            border-radius: var(--border-radius); 
            box-shadow: var(--box-shadow); 
            overflow-y: auto;
            max-height: 95vh;
        }
        .screen { display: none; }
        .screen.active { display: block; }
        h1, h2, h3 { text-align: center; color: var(--primary-color); }
        textarea { width: 100%; height: 250px; padding: 10px; font-size: 16px; border: 1px solid #ccc; border-radius: var(--border-radius); box-sizing: border-box; margin-bottom: 15px; overflow-y: auto; }
        .button-group { display: grid; grid-template-columns: 1fr; gap: 10px; margin-bottom: 20px; }
        .btn { padding: 12px; font-size: 16px; font-weight: bold; color: white; background-color: var(--primary-color); border: none; border-radius: var(--border-radius); cursor: pointer; text-align: center; transition: background-color 0.2s; }
        .btn:hover { background-color: #0056b3; }
        .btn-secondary { background-color: var(--secondary-color); }
        .btn-secondary:hover { background-color: #5a6268; }
        .question-container { margin-bottom: 25px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .question-text { font-size: 18px; margin-bottom: 5px; font-weight: bold; }
        .question-type-label { font-style: italic; color: #444; margin-bottom: 10px; }
        .options-container label { display: block; padding: 12px; border: 1px solid #ddd; border-radius: var(--border-radius); margin-bottom: 8px; cursor: pointer; transition: background-color 0.3s; }
        .options-container input { margin-right: 10px; }
        .options-container label.correct { background-color: #d4edda; border-color: var(--success-color); }
        .options-container label.incorrect { background-color: #f8d7da; border-color: var(--danger-color); }
        .feedback { color: var(--danger-color); font-weight: bold; margin-top: 10px; }
        #final-score { text-align: center; font-size: 24px; font-weight: bold; color: var(--primary-color); }
        .sidebar { width: 260px; max-height: 80vh; overflow-y: auto; }
        .main-content { transition: all 0.3s ease; }
        .with-sidebar { margin-left: 260px; width: calc(100% - 260px); }
        .full { margin-left: 0; width: 100%; }
        #startQuizBtn {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 24px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            display: none;
        }
        #startQuizBtn:hover { background-color: #218838; }
        #contentModal, #history-contentModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        #contentModalContent, #history-contentModalContent {
            background-color: var(--secondary-bg);
            margin: 5% auto;
            padding: 20px;
            border-radius: var(--border-radius);
            width: 80%;
            max-height: 70%;
            overflow-y: auto;
            box-shadow: var(--box-shadow);
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 h-screen overflow-hidden">
    <div class="container">
        <div id="home-screen" class="screen active">
            <h1>Quiz Offline</h1>
            <div class="button-group">
                <button class="btn" onclick="showScreen('creation-choice-screen')">T·∫°o ƒê·ªÅ Thi M·ªõi</button>
                <button class="btn btn-secondary" onclick="showScreen('saved-list-screen')">Xem B√†i ƒê√£ L∆∞u</button>
                <button class="btn btn-secondary" onclick="showScreen('history-list-screen')">Xem L·ªãch S·ª≠ L√†m B√†i</button>
                <button class="btn btn-secondary" onclick="importQuiz()">Nh·∫≠p B√†i Thi</button>
                <button class="btn btn-secondary" onclick="checkStorageQuota()">Ki·ªÉm Tra Dung L∆∞·ª£ng</button>
            </div>
        </div>

        <div id="creation-choice-screen" class="screen">
            <h2>Ch·ªçn Lo·∫°i D·ªØ Li·ªáu</h2>
            <div class="button-group">
                <button class="btn" onclick="showScreen('input-screen', 1)">1. Tr·∫Øc nghi·ªám 1 ƒë√°p √°n</button>
                <button class="btn" onclick="showScreen('input-screen', 2)">2. Tr·∫Øc nghi·ªám nhi·ªÅu ƒë√°p √°n / Tr·∫£ l·ªùi ng·∫Øn</button>
            </div>
        </div>
        
        <div id="input-screen" class="screen">
            <h2 id="input-title"></h2>
            <textarea id="manual-input" placeholder="D√°n n·ªôi dung c√¢u h·ªèi v√† ƒë√°p √°n v√†o ƒë√¢y..."></textarea>
            <p style="color: #666; font-size: 14px;">
                ƒê·ªãnh d·∫°ng c√¢u h·ªèi:<br>
                - Tr·∫Øc nghi·ªám: C√¢u 1: N·ªôi dung<br>*a) ƒê√°p √°n ƒë√∫ng<br>b) ƒê√°p √°n sai<br>
                - Tr·∫£ l·ªùi ng·∫Øn: C√¢u 1: N·ªôi dung<br>ƒê√ÅP √ÅN: C√¢u tr·∫£ l·ªùi
            </p>
            <div class="button-group">
                <input type="file" id="docx-upload" accept=".docx" style="margin-bottom: 10px;">
                <button id="create-quiz-btn" class="btn">T·∫°o B√†i Thi</button>
            </div>
        </div>

        <div id="preview-screen" class="screen">
            <h2>Ki·ªÉm Tra L·∫°i D·ªØ Li·ªáu</h2>
            <div id="preview-container" style="max-height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; border-radius: 8px; margin-bottom: 20px;">
            </div>
            <div class="button-group">
                 <button class="btn" onclick="prepareQuizUI(currentQuiz, true)">B·∫Øt ƒê·∫ßu L√†m B√†i</button>
                 <button class="btn btn-secondary" onclick="showScreen('creation-choice-screen')">Quay L·∫°i</button>
            </div>
        </div>
        
        <div id="saved-list-screen" class="screen">
            <div id="sidebar" class="sidebar fixed top-0 left-0 h-full bg-white shadow transition-transform duration-300">
                <div class="p-4 font-bold">üìë B√†i Thi ƒê√£ L∆∞u</div>
                <div id="saved-quizzes-list" class="space-y-2 p-2"></div>
            </div>
            <div id="mainContent" class="main-content with-sidebar h-full flex flex-col items-center justify-center text-center p-6">
                <h1 class="text-2xl font-bold mb-4">Danh s√°ch b√†i thi</h1>
                <p class="text-gray-600">üëâ Vu·ªët sang tr√°i ƒë·ªÉ ·∫©n sidebar, vu·ªët sang ph·∫£i ƒë·ªÉ m·ªü l·∫°i.</p>
                <div id="questionBox" class="mt-6 p-4 bg-white rounded-xl shadow max-w-md hidden text-left space-y-4"></div>
                <button id="exportQuizBtn" class="btn btn-secondary" style="display:none;" onclick="exportSelectedQuizzes()">Xu·∫•t B√†i Thi</button>
            </div>
            <div id="contentModal">
                <div id="contentModalContent">
                    <h3 id="modalTitle"></h3>
                    <div id="modalContent"></div>
                    <div class="button-group mt-4">
                        <button class="btn btn-secondary" onclick="closeModal()">Quay l·∫°i</button>
                        <button id="startFromModalBtn" class="btn" style="display:none;" onclick="startFromModal()">B·∫Øt ƒë·∫ßu l√†m b√†i</button>
                        <button class="btn" style="background-color: #dc3545;" onclick="deleteQuizFromModal()">X√≥a</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="history-list-screen" class="screen">
            <div id="history-sidebar" class="sidebar fixed top-0 left-0 h-full bg-white shadow transition-transform duration-300">
                <div class="p-4 font-bold">üìú L·ªãch S·ª≠ L√†m B√†i</div>
                <div id="history-list" class="space-y-2 p-2"></div>
            </div>
            <div id="history-mainContent" class="main-content with-sidebar h-full flex flex-col items-center justify-center text-center p-6">
                <h1 class="text-2xl font-bold mb-4">Danh s√°ch l·ªãch s·ª≠ l√†m b√†i</h1>
                <p class="text-gray-600">üëâ Vu·ªët sang tr√°i ƒë·ªÉ ·∫©n sidebar, vu·ªët sang ph·∫£i ƒë·ªÉ m·ªü l·∫°i.</p>
                <div id="history-questionBox" class="mt-6 p-4 bg-white rounded-xl shadow max-w-md hidden text-left space-y-4"></div>
            </div>
            <div id="history-contentModal">
                <div id="history-contentModalContent">
                    <h3 id="history-modalTitle"></h3>
                    <div id="history-modalContent"></div>
                    <div class="button-group mt-4">
                        <button class="btn btn-secondary" onclick="closeHistoryModal()">Quay l·∫°i</button>
                        <button class="btn" style="background-color: #dc3545;" onclick="deleteHistoryFromModal()">X√≥a</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="quiz-section" class="screen">
            <h2 id="quiz-title">N·ªôi dung b√†i thi</h2>
            <div id="quiz-live-container"></div>
            <div id="results-container" style="display:none;">
                <h2>K·∫øt Qu·∫£</h2>
                <p id="final-score"></p>
            </div>
            <div class="button-group">
                <button id="start-btn" class="btn" style="display:none;">B·∫Øt ƒê·∫ßu</button>
                <button id="shuffle-btn" class="btn" style="display:none;">Tr·ªôn c√¢u h·ªèi v√† ƒë√°p √°n: T·∫Øt</button>
                <button id="save-btn" class="btn btn-secondary" style="display:none;">L∆∞u B√†i N√†y</button>
                <button id="submit-early-btn" class="btn" style="display:none; background-color: #ffc107;" onclick="submitEarly()">N·ªôp B√†i S·ªõm</button>
            </div>
        </div>

        <button id="startQuizBtn" onclick="startSelectedQuiz()">B·∫Øt ƒê·∫ßu L√†m B√†i</button>
    </div>

    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <script>
        let currentQuiz = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let isShuffled = false;
        let selectedQuizzes = new Set();
        let currentModalQuiz = null;
        let userAnswers = [];
        let currentModalHistory = null;
        let isQuizStarted = false;
        let currentScreen = 'home-screen';
        let lastScreen = 'home-screen';
        let isPopping = false;
        let db = null;

        // H√†m hi·ªÉn th·ªã loading spinner
        function showLoading(show) {
            document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
        }

        // Debounce h√†m ƒë·ªÉ h·∫°n ch·∫ø c·∫≠p nh·∫≠t giao di·ªán
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Ki·ªÉm tra dung l∆∞·ª£ng localStorage
        function checkLocalStorageQuota(data) {
            try {
                let total = 0;
                for (let x in localStorage) {
                    if (localStorage.hasOwnProperty(x)) {
                        total += ((localStorage[x].length + x.length) * 2);
                    }
                }
                const newDataSize = JSON.stringify(data).length * 2;
                if (total + newDataSize > 4 * 1024 * 1024) {
                    console.log("H·∫øt quota localStorage, chuy·ªÉn sang IndexedDB");
                    return false;
                }
                return true;
            } catch (e) {
                console.error("L·ªói ki·ªÉm tra quota: ", e);
                return false;
            }
        }

        // Kh·ªüi t·∫°o IndexedDB
        function initIndexedDB() {
            if (db) return Promise.resolve(db);
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('QuizAppDB', 1);
                request.onupgradeneeded = function(event) {
                    db = event.target.result;
                    db.createObjectStore('quizStore', { keyPath: 'id' });
                };
                request.onsuccess = function(event) {
                    db = event.target.result;
                    resolve(db);
                };
                request.onerror = function(event) {
                    console.error("L·ªói m·ªü IndexedDB: ", event);
                    reject(null);
                };
            });
        }

        // L∆∞u v√†o IndexedDB
        async function saveToIndexedDB(key, value) {
            try {
                const database = await initIndexedDB();
                return new Promise((resolve, reject) => {
                    const transaction = database.transaction(['quizStore'], 'readwrite');
                    const store = transaction.objectStore('quizStore');
                    const request = store.put({ id: key, data: value });
                    request.onsuccess = () => resolve(true);
                    request.onerror = () => {
                        console.error("L·ªói l∆∞u IndexedDB: ", key);
                        reject(false);
                    };
                });
            } catch (e) {
                alert("L·ªói l∆∞u v√†o IndexedDB!");
                return false;
            }
        }

        // L·∫•y t·ª´ IndexedDB
        async function getFromIndexedDB(key) {
            try {
                const database = await initIndexedDB();
                return new Promise((resolve, reject) => {
                    const transaction = database.transaction(['quizStore'], 'readonly');
                    const store = transaction.objectStore('quizStore');
                    const request = store.get(key);
                    request.onsuccess = () => resolve(request.result ? request.result.data : null);
                    request.onerror = () => {
                        console.error("L·ªói l·∫•y t·ª´ IndexedDB: ", key);
                        reject(null);
                    };
                });
            } catch (e) {
                return null;
            }
        }

        // Ki·ªÉm tra dung l∆∞·ª£ng c√≤n l·∫°i
        function checkStorageQuota() {
            let localStorageUsed = 0;
            for (let x in localStorage) {
                if (localStorage.hasOwnProperty(x)) {
                    localStorageUsed += ((localStorage[x].length + x.length) * 2);
                }
            }
            const localStorageTotal = 5 * 1024 * 1024;
            const localStorageRemaining = (localStorageTotal - localStorageUsed) / (1024 * 1024);

            navigator.storage.estimate().then(estimate => {
                const indexedDBQuota = estimate.quota / (1024 * 1024);
                const indexedDBUsed = estimate.usage / (1024 * 1024);
                const indexedDBRemaining = indexedDBQuota - indexedDBUsed;
                alert(`Dung l∆∞·ª£ng c√≤n l·∫°i:\n- localStorage: ${localStorageRemaining.toFixed(2)} MB (t·ªïng ~5MB)\n- IndexedDB: ${indexedDBRemaining.toFixed(2)} MB (t·ªïng ~${indexedDBQuota.toFixed(2)} MB)`);
            }).catch(() => {
                alert(`Dung l∆∞·ª£ng c√≤n l·∫°i:\n- localStorage: ${localStorageRemaining.toFixed(2)} MB (t·ªïng ~5MB)\n- IndexedDB: Kh√¥ng th·ªÉ ki·ªÉm tra (h·ªó tr·ª£ ~50-200MB t√πy thi·∫øt b·ªã)`);
            });
        }

        // Xu·∫•t b√†i thi ƒë√£ ch·ªçn
        function exportSelectedQuizzes() {
            if (selectedQuizzes.size === 0) {
                alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt b√†i thi ƒë·ªÉ xu·∫•t!');
                return;
            }
            showLoading(true);
            setTimeout(() => {
                const savedQuizzes = getSavedQuizzes();
                const exportData = {};
                selectedQuizzes.forEach(quizName => {
                    exportData[quizName] = savedQuizzes[quizName];
                });
                const jsonString = JSON.stringify(exportData);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `quiz_export_${new Date().toLocaleDateString('vi-VN').replace(/\//g, '-')}.json`;
                a.click();
                URL.revokeObjectURL(url);
                alert('ƒê√£ xu·∫•t b√†i thi th√†nh file JSON!');
                showLoading(false);
            }, 0);
        }

        // Nh·∫≠p b√†i thi t·ª´ file JSON
        function importQuiz() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    showLoading(true);
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const importedData = JSON.parse(e.target.result);
                            const quizzes = Object.values(importedData);
                            if (quizzes.length === 0 || !Array.isArray(quizzes[0])) {
                                alert('File JSON kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng! C·∫ßn ch·ª©a danh s√°ch b√†i thi.');
                                showLoading(false);
                                return;
                            }
                            currentQuiz = quizzes.reduce((acc, quiz) => acc.concat(quiz), []);
                            prepareQuizUI(currentQuiz, true);
                            alert('ƒê√£ nh·∫≠p b√†i thi th√†nh c√¥ng! B·∫Øt ƒë·∫ßu l√†m b√†i.');
                        } catch (err) {
                            console.error(err);
                            alert('L·ªói khi ƒë·ªçc file JSON!');
                        } finally {
                            showLoading(false);
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function showScreen(screenId, type) {
            if (currentScreen === screenId) return;
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            const targetScreen = document.getElementById(screenId);
            targetScreen.classList.add('active');
            lastScreen = currentScreen;
            currentScreen = screenId;

            if (screenId === 'home-screen') {
                currentQuiz = [];
                isQuizStarted = false;
                userAnswers = [];
                score = 0;
                currentQuestionIndex = 0;
                selectedQuizzes.clear();
            }

            if (!isPopping) {
                history.pushState({ screen: screenId }, '');
            }

            if (screenId === 'input-screen' && type) {
                const title = document.getElementById('input-title');
                const button = document.getElementById('create-quiz-btn');
                if (type === 1) {
                    title.textContent = "Nh·∫≠p tr·∫Øc nghi·ªám 1 ƒë√°p √°n";
                    button.onclick = () => createQuiz(1);
                } else {
                    title.textContent = "Nh·∫≠p tr·∫Øc nghi·ªám nhi·ªÅu ƒë√°p √°n / Tr·∫£ l·ªùi ng·∫Øn";
                    button.onclick = () => createQuiz(2);
                }
            } else if (screenId === 'saved-list-screen') {
                debouncedRenderSavedQuizzesList();
                toggleSidebar(true);
                updateStartButton();
            } else if (screenId === 'history-list-screen') {
                debouncedRenderHistoryList();
                toggleHistorySidebar(true);
            }
        }

        function createQuiz(parserType) {
            const text = document.getElementById('manual-input').value;
            if (!text.trim()) {
                alert('Vui l√≤ng nh·∫≠p n·ªôi dung c√¢u h·ªèi!');
                return;
            }
            showLoading(true);
            setTimeout(() => {
                const parser = parserType === 1 ? parseType1 : parseType2;
                const questions = parser(text);
                if (questions.length === 0) {
                    alert('Kh√¥ng t√¨m th·∫•y c√¢u h·ªèi h·ª£p l·ªá. Vui l√≤ng ki·ªÉm tra ƒë·ªãnh d·∫°ng:\n' +
                          '- Tr·∫Øc nghi·ªám: "C√¢u 1: N·ªôi dung\\n*a) ƒê√°p √°n ƒë√∫ng\\nb) ƒê√°p √°n sai"\n' +
                          '- Tr·∫£ l·ªùi ng·∫Øn: "C√¢u 1: N·ªôi dung\\nƒê√ÅP √ÅN: C√¢u tr·∫£ l·ªùi"');
                    showLoading(false);
                    return;
                }
                currentQuiz = questions;
                renderPreview(questions);
                showScreen('preview-screen');
                showLoading(false);
            }, 0);
        }

        function renderPreview(questions) {
            const container = document.getElementById('preview-container');
            container.innerHTML = '';
            if (questions.length === 0) {
                container.innerHTML = '<p>Kh√¥ng c√≥ c√¢u h·ªèi n√†o ƒë∆∞·ª£c nh·∫≠n di·ªán.</p>';
                return;
            }

            const fragment = document.createDocumentFragment();
            questions.forEach((q, index) => {
                const div = document.createElement('div');
                div.style.cssText = 'margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee;';
                let questionHTML = `<p><strong>C√¢u ${index + 1}:</strong> ${q.cau_hoi.replace(/\n/g, '<br>')}</p>`;
                
                if (q.type === 'short_answer') {
                    questionHTML += `<p style="color: green;"><em>ƒê√°p √°n ƒë√∫ng: ${q.dap_an_dung.join(' / ')}</em></p>`;
                } else {
                    questionHTML += '<ul>';
                    q.lua_chon.forEach(option => {
                        const isCorrect = q.dap_an_dung.includes(option);
                        questionHTML += `<li style="color: ${isCorrect ? 'green' : 'black'}; font-weight: ${isCorrect ? 'bold' : 'normal'};">${option} ${isCorrect ? '‚úî' : ''}</li>`;
                    });
                    questionHTML += '</ul>';
                }
                div.innerHTML = questionHTML;
                fragment.appendChild(div);
            });
            container.appendChild(fragment);
        }

        function parseQuestions(text) {
            const lines = text.split('\n');
            const questions = [];
            let currentQuestion = null;
            const questionRegex = /^(c√¢u|question)\s*\d+\s*[:.]/i;
            for (const line of lines) {
                if (!line.trim()) continue;
                if (questionRegex.test(line)) {
                    if (currentQuestion) questions.push(currentQuestion);
                    currentQuestion = { text: [line], raw: line.replace(questionRegex, '').trim() };
                } else if (currentQuestion) {
                    currentQuestion.text.push(line);
                }
            }
            if (currentQuestion) questions.push(currentQuestion);
            return questions;
        }

        function parseType1(text) {
            return parseQuestions(text).map(q => {
                const questionData = { cau_hoi: q.raw, lua_chon: [], dap_an_dung: [], type: 'multiple_choice' };
                q.text.slice(1).forEach(line => {
                    const parts = line.split('\t').map(p => p.trim());
                    parts.forEach(part => {
                        if (!part) return;
                        const trimmedPart = part;
                        const isCorrect = trimmedPart.startsWith('*');
                        const cleanPart = isCorrect ? trimmedPart.substring(1).trim() : trimmedPart;
                        if (/^[a-z][.)]/i.test(cleanPart)) { 
                            questionData.lua_chon.push(cleanPart);
                            if (isCorrect) questionData.dap_an_dung.push(cleanPart);
                        } else {
                            questionData.cau_hoi += '\n' + cleanPart; 
                        }
                    });
                });
                return questionData;
            }).filter(q => q.lua_chon.length > 0 && q.dap_an_dung.length === 1);
        }

        function parseType2(text) {
            return parseQuestions(text).map(q => {
                let choices = [];
                let correctChoices = [];
                let shortAnswer = [];
                let questionText = q.raw;
                const answerKeywordRegex = /^\s*(ƒë√°p √°n|ƒë√ÅP √ÅN|dap an)\s*:/i;
                q.text.slice(1).forEach(line => {
                    const parts = line.split('\t').map(p => p.trim());
                    parts.forEach(part => {
                        if (!part) return;
                        const trimmedPart = part;
                        const isCorrect = trimmedPart.startsWith('*');
                        const cleanPart = isCorrect ? trimmedPart.substring(1).trim() : trimmedPart;
                        if (/^[a-z][.)]/i.test(cleanPart)) { 
                            choices.push(cleanPart);
                            if (isCorrect) correctChoices.push(cleanPart);
                        } else if (answerKeywordRegex.test(trimmedPart)) {
                            shortAnswer.push(trimmedPart.replace(answerKeywordRegex, '').trim());
                        } else if (isCorrect && choices.length === 0) {
                            shortAnswer.push(cleanPart);
                        } else {
                            questionText += '\n' + trimmedPart;
                        }
                    });
                });
                if (choices.length > 0) {
                    return { 
                        cau_hoi: questionText, 
                        lua_chon: choices, 
                        dap_an_dung: correctChoices, 
                        type: correctChoices.length > 1 ? 'multiple_answer' : 'multiple_choice' 
                    };
                } else if (shortAnswer.length > 0) {
                    return { 
                        cau_hoi: questionText, 
                        lua_chon: [], 
                        dap_an_dung: shortAnswer, 
                        type: 'short_answer' 
                    };
                } else {
                    return null;
                }
            }).filter(q => q !== null && q.dap_an_dung.length > 0);
        }

        function prepareQuizUI(questions, doShowScreen = true) {
            currentQuiz = questions;
            isShuffled = false;
            if (doShowScreen) {
                showScreen('quiz-section');
            }
            const container = document.getElementById('quiz-live-container');
            container.innerHTML = '';
            document.getElementById('results-container').style.display = 'none';
            const startBtn = document.getElementById('start-btn');
            startBtn.style.display = 'inline-block'; startBtn.textContent = 'B·∫Øt ƒê·∫ßu'; startBtn.onclick = startQuiz;
            const shuffleBtn = document.getElementById('shuffle-btn');
            shuffleBtn.style.display = 'inline-block'; 
            shuffleBtn.textContent = 'Tr·ªôn ƒë√°p √°n: T·∫Øt';
            shuffleBtn.onclick = toggleShuffle;
            const saveBtn = document.getElementById('save-btn');
            saveBtn.style.display = 'inline-block'; saveBtn.textContent = 'L∆∞u B√†i N√†y'; saveBtn.onclick = saveQuiz;
        }

        function startQuiz() {
            score = 0; currentQuestionIndex = 0;
            userAnswers = [];
            isQuizStarted = true;
            // Kh√¥ng tr·ªôn th·ª© t·ª± c√¢u h·ªèi, gi·ªØ nguy√™n currentQuiz
            document.getElementById('start-btn').style.display = 'none';
            document.getElementById('shuffle-btn').style.display = 'none';
            document.getElementById('save-btn').style.display = 'none';
            document.getElementById('submit-early-btn').style.display = 'inline-block';
            displayQuestion();
        }

        function displayQuestion() {
            const container = document.getElementById('quiz-live-container');
            if (currentQuestionIndex >= currentQuiz.length) { showResults(); return; }
            const q = currentQuiz[currentQuestionIndex];

            let optionsToDisplay = [...q.lua_chon];
            let correctAnswers = [...q.dap_an_dung];
            let optionMapping = {};

            if (isShuffled && (q.type === 'multiple_choice' || q.type === 'multiple_answer')) {
                // Tr·ªôn n·ªôi dung ƒë√°p √°n ng·∫´u nhi√™n
                let shuffledOptions = [...optionsToDisplay];
                for (let i = shuffledOptions.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffledOptions[i], shuffledOptions[j]] = [shuffledOptions[j], shuffledOptions[i]];
                }

                // T·∫°o √°nh x·∫° gi·ªØa ƒë√°p √°n g·ªëc v√† ƒë√°p √°n tr·ªôn
                optionMapping = {};
                shuffledOptions.forEach((option, index) => {
                    const label = String.fromCharCode(97 + index); // a, b, c, d...
                    optionMapping[label] = option;
                });

                // C·∫≠p nh·∫≠t ƒë√°p √°n ƒë√∫ng theo √°nh x·∫°
                correctAnswers = q.dap_an_dung.map(correct => {
                    const newLabel = Object.keys(optionMapping).find(label => optionMapping[label] === correct);
                    return newLabel;
                });

                // S·∫Øp x·∫øp ƒë√°p √°n theo th·ª© t·ª± b·∫£ng ch·ªØ c√°i
                optionsToDisplay = Object.keys(optionMapping)
                    .sort()
                    .map(label => optionMapping[label]);

                console.log(`C√¢u ${currentQuestionIndex + 1} - ƒê√°p √°n g·ªëc: ${q.dap_an_dung}, ƒê√°p √°n sau tr·ªôn: ${correctAnswers}`);
            }

            const fragment = document.createDocumentFragment();
            const div = document.createElement('div');
            div.className = 'question-container';
            div.id = `q-${currentQuestionIndex}`;
            let questionHTML = `<p class="question-text">C√¢u ${currentQuestionIndex + 1}: ${q.cau_hoi ? q.cau_hoi.replace(/\n/g, '<br>') : 'N·ªôi dung kh√¥ng x√°c ƒë·ªãnh'}</p>
                <div class="options-container">`;

            if (q.type === 'multiple_choice') {
                optionsToDisplay.forEach((option, i) => {
                    const label = String.fromCharCode(97 + i); // a, b, c, d...
                    questionHTML += `<label><input type="radio" name="option-${currentQuestionIndex}" value="${label}"> ${option}</label>`;
                });
            } else if (q.type === 'multiple_answer') {
                optionsToDisplay.forEach((option, i) => {
                    const label = String.fromCharCode(97 + i); // a, b, c, d...
                    questionHTML += `<label><input type="checkbox" name="option-${currentQuestionIndex}" value="${label}"> ${option}</label>`;
                });
            } else {
                questionHTML += `<input type="text" id="short-answer-input-${currentQuestionIndex}" placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi..." style="width:100%; padding:10px; font-size:16px;">`;
            }
            questionHTML += `</div><div class="feedback"></div><button class="btn" style="margin-top:15px;" onclick="checkAnswer(${JSON.stringify(correctAnswers)})">Tr·∫£ L·ªùi</button>`;
            div.innerHTML = questionHTML;
            fragment.appendChild(div);
            container.innerHTML = '';
            container.appendChild(fragment);
        }

        function checkAnswer(correctAnswers) {
            const q = currentQuiz[currentQuestionIndex];
            const container = document.getElementById(`q-${currentQuestionIndex}`);
            const inputs = container.querySelectorAll('input');
            const feedbackDiv = container.querySelector('.feedback');
            let isCorrect = false;
            let selected = [];
            inputs.forEach(input => input.disabled = true);
            
            if (q.type === 'multiple_choice') {
                const sel = container.querySelector(`input[type="radio"][name="option-${currentQuestionIndex}"]:checked`);
                if (sel) {
                    selected = [sel.value];
                    isCorrect = correctAnswers.includes(sel.value);
                }
                feedbackDiv.textContent = `${isCorrect ? 'ƒê√∫ng' : 'Sai'}`;
                if (!isCorrect) feedbackDiv.textContent += ` - ƒê√°p √°n ƒë√∫ng: ${correctAnswers.map(label => {
                    const index = label.charCodeAt(0) - 97;
                    return q.lua_chon[index];
                }).join(', ')}`;
            } else if (q.type === 'multiple_answer') {
                selected = Array.from(container.querySelectorAll(`input[type="checkbox"][name="option-${currentQuestionIndex}"]:checked`)).map(el => el.value);
                isCorrect = selected.length === correctAnswers.length && selected.sort().toString() === correctAnswers.sort().toString();
                feedbackDiv.textContent = `${isCorrect ? 'ƒê√∫ng' : 'Sai'}`;
                if (!isCorrect) feedbackDiv.textContent += ` - ƒê√°p √°n ƒë√∫ng: ${correctAnswers.map(label => {
                    const index = label.charCodeAt(0) - 97;
                    return q.lua_chon[index];
                }).join(', ')}`;
            } else {
                const userAnswer = container.querySelector(`#short-answer-input-${currentQuestionIndex}`).value.trim();
                selected = [userAnswer];
                isCorrect = q.dap_an_dung.some(ans => ans.toLowerCase() === userAnswer.toLowerCase());
                feedbackDiv.textContent = `${isCorrect ? 'ƒê√∫ng' : 'Sai'}`;
                if (!isCorrect) feedbackDiv.textContent += ` - ƒê√°p √°n ƒë√∫ng: ${q.dap_an_dung.join(' ho·∫∑c ')}`;
            }

            userAnswers.push({ questionIndex: currentQuestionIndex, selected, isCorrect });

            if (isCorrect) score++;
            container.querySelectorAll('label').forEach(label => {
                const input = label.querySelector('input');
                if (correctAnswers.includes(input.value)) label.classList.add('correct');
                else if (input.checked) label.classList.add('incorrect');
            });

            const button = container.querySelector('button');
            button.textContent = 'C√¢u Ti·∫øp Theo'; button.onclick = nextQuestion;
        }

        function nextQuestion() { currentQuestionIndex++; displayQuestion(); }

        function submitEarly() {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën n·ªôp b√†i s·ªõm kh√¥ng? C√°c c√¢u ch∆∞a l√†m s·∫Ω coi nh∆∞ sai.')) {
                showResults();
                showScreen('home-screen');
            }
        }

        function showResults() {
            isQuizStarted = false;
            document.getElementById('quiz-live-container').innerHTML = '';
            const resultsContainer = document.getElementById('results-container');
            resultsContainer.style.display = 'block';
            const total = currentQuiz.length;
            const isComplete = currentQuestionIndex >= total;
            const baseScore = total > 0 ? (score / total) * 10 : 0;
            const bonus = isComplete ? 1 : 0.5;
            const totalPoint = baseScore + bonus;
            document.getElementById('final-score').textContent = `B·∫°n ƒë√£ ƒë√∫ng ${score} / ${total} c√¢u! ƒêi·ªÉm: ${totalPoint.toFixed(2)} / 10 (Bonus: ${bonus})`;
            
            saveHistory(userAnswers, score, total, isComplete);
            
            const startBtn = document.getElementById('start-btn');
            startBtn.style.display = 'inline-block'; startBtn.textContent = 'L√†m L·∫°i'; startBtn.onclick = startQuiz;
            document.getElementById('submit-early-btn').style.display = 'none';
        }

        function toggleShuffle() {
            isShuffled = !isShuffled;
            document.getElementById('shuffle-btn').textContent = `Tr·ªôn ƒë√°p √°n: ${isShuffled ? 'B·∫≠t' : 'T·∫Øt'}`;
        }

        function getSavedQuizzes() {
            if (window.Android) {
                const jsonData = window.Android.loadData("savedQuizzes.json");
                return JSON.parse(LZString.decompress(jsonData) || '{}');
            } else {
                const localData = localStorage.getItem('savedQuizzes');
                if (localData) {
                    return JSON.parse(LZString.decompress(localData) || '{}');
                }
                return getFromIndexedDB('savedQuizzes').then(data => data ? JSON.parse(LZString.decompress(data) || '{}') : {});
            }
        }

        async function setSavedQuizzes(savedQuizzes) {
            const compressed = LZString.compress(JSON.stringify(savedQuizzes));
            if (window.Android) {
                const success = window.Android.saveData("savedQuizzes.json", compressed);
                if (!success) {
                    alert("L·ªói l∆∞u b√†i thi. Ki·ªÉm tra quy·ªÅn truy c·∫≠p b·ªô nh·ªõ!");
                    return false;
                }
                return true;
            } else {
                if (checkLocalStorageQuota(compressed)) {
                    localStorage.setItem('savedQuizzes', compressed);
                    return true;
                } else {
                    return await saveToIndexedDB('savedQuizzes', compressed);
                }
            }
        }

        function getQuizHistory() {
            if (window.Android) {
                const jsonData = window.Android.loadData("quizHistory.json");
                return JSON.parse(LZString.decompress(jsonData) || '[]');
            } else {
                const localData = localStorage.getItem('quizHistory');
                if (localData) {
                    return JSON.parse(LZString.decompress(localData) || '[]');
                }
                return getFromIndexedDB('quizHistory').then(data => data ? JSON.parse(LZString.decompress(data) || '[]') : []);
            }
        }

        async function setQuizHistory(history) {
            const compressed = LZString.compress(JSON.stringify(history));
            if (window.Android) {
                const success = window.Android.saveData("quizHistory.json", compressed);
                if (!success) {
                    alert("L·ªói l∆∞u l·ªãch s·ª≠. Ki·ªÉm tra quy·ªÅn truy c·∫≠p b·ªô nh·ªõ!");
                    return false;
                }
                return true;
            } else {
                if (checkLocalStorageQuota(compressed)) {
                    localStorage.setItem('quizHistory', compressed);
                    return true;
                } else {
                    return await saveToIndexedDB('quizHistory', compressed);
                }
            }
        }

        function saveQuiz() {
            const name = prompt("Nh·∫≠p t√™n ƒë·ªÉ l∆∞u b√†i thi n√†y:", `B√†i thi ng√†y ${new Date().toLocaleDateString('vi-VN')}`);
            if (name) {
                showLoading(true);
                setTimeout(async () => {
                    const savedQuizzes = getSavedQuizzes();
                    if (savedQuizzes[name]) {
                        alert("T√™n b√†i thi ƒë√£ t·ªìn t·∫°i! Vui l√≤ng ch·ªçn t√™n kh√°c.");
                        showLoading(false);
                        return;
                    }
                    savedQuizzes[name] = currentQuiz;
                    const success = await setSavedQuizzes(savedQuizzes);
                    if (success) {
                        alert(`ƒê√£ l∆∞u b√†i thi "${name}"!`);
                        debouncedRenderSavedQuizzesList();
                        updateStartButton();
                    }
                    showLoading(false);
                }, 0);
            }
        }

        const debouncedRenderSavedQuizzesList = debounce(() => {
            const container = document.getElementById('saved-quizzes-list');
            container.innerHTML = '';
            const quizzes = getSavedQuizzes();
            const keys = Object.keys(quizzes);

            if (keys.length === 0) {
                container.innerHTML = '<p class="text-gray-500">Ch∆∞a c√≥ b√†i n√†o ƒë∆∞·ª£c l∆∞u.</p>';
                updateStartButton();
                return;
            }

            const fragment = document.createDocumentFragment();
            keys.forEach((key, index) => {
                const btn = document.createElement('div');
                const originalColor = index % 3 === 0 ? 'blue' : index % 3 === 1 ? 'green' : 'purple';
                btn.className = `question-btn px-4 py-2 bg-${originalColor}-500 text-white rounded-full cursor-pointer`;
                btn.dataset.id = key;
                btn.dataset.originalClass = btn.className;
                btn.dataset.content = `N·ªôi dung b√†i thi "${key}" (S·ªë c√¢u: ${quizzes[key].length}) ${selectedQuizzes.has(key) ? `(ƒë√£ ch·ªçn ${selectedQuizzes.size} b√†i)` : ''}`;
                btn.textContent = `B√†i ${index + 1}: ${key}`;
                btn.onclick = () => {
                    const qid = btn.dataset.id;
                    const existing = document.getElementById(`box-${qid}`);
                    const isOpen = existing !== null;

                    if (isOpen) {
                        existing.remove();
                        btn.className = btn.dataset.originalClass;
                        selectedQuizzes.delete(qid);
                        syncSelection(qid, false);
                    } else {
                        const div = document.createElement("div");
                        div.id = `box-${qid}`;
                        div.className = "p-3 border rounded bg-gray-50";
                        div.innerHTML = `<p><span class="cursor-pointer text-blue-500" onclick="showContent('${qid}')">${btn.dataset.content}</span></p><button class="btn btn-secondary mt-2" onclick="toggleSelection('${qid}')">${selectedQuizzes.has(qid) ? 'B·ªè ch·ªçn' : 'Ch·ªçn'}</button><button class="btn mt-2 ml-2" onclick="viewQuiz('${qid}')">Xem</button>`;
                        document.getElementById('questionBox').appendChild(div);
                        document.getElementById('questionBox').classList.remove("hidden");
                        btn.className = btn.className.replace(`${originalColor}-500`, 'gray-500');
                        if (!selectedQuizzes.has(qid)) {
                            selectedQuizzes.add(qid);
                            syncSelection(qid, true);
                        }
                    }

                    if (document.getElementById('questionBox').children.length === 0) {
                        document.getElementById('questionBox').classList.add("hidden");
                    }
                    console.log('Selected quizzes:', Array.from(selectedQuizzes));
                    updateStartButton();
                };
                fragment.appendChild(btn);
            });
            container.appendChild(fragment);
            updateExportButton();
            updateStartButton();
        }, 100);

        function updateExportButton() {
            const exportBtn = document.getElementById('exportQuizBtn');
            exportBtn.style.display = selectedQuizzes.size > 0 ? 'block' : 'none';
        }

        function toggleSelection(qid) {
            const btn = document.querySelector(`[data-id="${qid}"]`);
            const existing = document.getElementById(`box-${qid}`);
            if (selectedQuizzes.has(qid)) {
                selectedQuizzes.delete(qid);
                existing.querySelector('button:nth-child(2)').textContent = "Ch·ªçn";
                existing.querySelector('p span').textContent = `N·ªôi dung b√†i thi "${qid}" (S·ªë c√¢u: ${getSavedQuizzes()[qid].length})`;
                btn.dataset.content = `N·ªôi dung b√†i thi "${qid}" (S·ªë c√¢u: ${getSavedQuizzes()[qid].length})`;
                btn.className = btn.dataset.originalClass;
                syncSelection(qid, false);
            } else {
                selectedQuizzes.add(qid);
                existing.querySelector('button:nth-child(2)').textContent = "B·ªè ch·ªçn";
                existing.querySelector('p span').textContent += ` (ƒë√£ ch·ªçn ${selectedQuizzes.size} b√†i)`;
                btn.dataset.content += ` (ƒë√£ ch·ªçn ${selectedQuizzes.size} b√†i)`;
                btn.className = btn.className.replace(/blue|green|purple/, 'gray') + '-500';
                syncSelection(qid, true);
            }
            console.log('Toggled selection for', qid, 'Selected quizzes:', Array.from(selectedQuizzes));
            updateStartButton();
            updateExportButton();
        }

        function syncSelection(qid, isSelected) {
            const btn = document.querySelector(`[data-id="${qid}"]`);
            const existing = document.getElementById(`box-${qid}`);
            if (existing) {
                existing.querySelector('button:nth-child(2)').textContent = isSelected ? "B·ªè ch·ªçn" : "Ch·ªçn";
                existing.querySelector('p span').textContent = `N·ªôi dung b√†i thi "${qid}" (S·ªë c√¢u: ${getSavedQuizzes()[qid].length})${isSelected ? ` (ƒë√£ ch·ªçn ${selectedQuizzes.size} b√†i)` : ''}`;
                btn.dataset.content = `N·ªôi dung b√†i thi "${qid}" (S·ªë c√¢u: ${getSavedQuizzes()[qid].length})${isSelected ? ` (ƒë√£ ch·ªçn ${selectedQuizzes.size} b√†i)` : ''}`;
                btn.className = isSelected ? btn.className.replace(/blue|green|purple/, 'gray') + '-500' : btn.dataset.originalClass;
            }
        }

        function updateStartButton() {
            const startBtn = document.getElementById('startQuizBtn');
            startBtn.style.display = selectedQuizzes.size > 0 ? 'block' : 'none';
            console.log('Start button visibility:', startBtn.style.display, 'Selected quizzes:', Array.from(selectedQuizzes));
        }

        function startSelectedQuiz() {
            const savedQuizzes = getSavedQuizzes();
            let combinedQuiz = [];
            if (selectedQuizzes.size > 0) {
                selectedQuizzes.forEach(quizName => {
                    combinedQuiz = combinedQuiz.concat(savedQuizzes[quizName]);
                });
                prepareQuizUI(combinedQuiz, true);
            }
            selectedQuizzes.clear();
            debouncedRenderSavedQuizzesList();
            document.getElementById('questionBox').innerHTML = '';
            document.getElementById('questionBox').classList.add("hidden");
            updateStartButton();
        }

        function startFromModal() {
            if (currentModalQuiz) {
                prepareQuizUI(currentModalQuiz, true);
                closeModal();
            }
        }

        function showContent(qid) {
            const savedQuizzes = getSavedQuizzes();
            if (!savedQuizzes[qid]) {
                alert(`Kh√¥ng t√¨m th·∫•y b√†i thi "${qid}"!`);
                return;
            }
            currentModalQuiz = savedQuizzes[qid];
            const modal = document.getElementById('contentModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');
            const startBtn = document.getElementById('startFromModalBtn');

            modalTitle.textContent = `N·ªôi dung b√†i thi: ${qid}`;
            modalContent.innerHTML = '<h4>Danh s√°ch c√¢u h·ªèi:</h4>';
            const fragment = document.createDocumentFragment();
            currentModalQuiz.forEach((q, index) => {
                const div = document.createElement('div');
                div.style.cssText = 'margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px solid #eee;';
                let contentHTML = `<p><strong>C√¢u ${index + 1}:</strong> ${q.cau_hoi || 'N·ªôi dung kh√¥ng x√°c ƒë·ªãnh'}</p>`;
                contentHTML += `<p class="question-type-label">Lo·∫°i: ${q.type === 'multiple_choice' ? 'Tr·∫Øc nghi·ªám (1 ƒë√°p √°n)' : q.type === 'multiple_answer' ? 'Tr·∫Øc nghi·ªám (Nhi·ªÅu ƒë√°p √°n)' : 'Tr·∫£ l·ªùi ng·∫Øn'}</p>`;
                if (q.lua_chon.length > 0) {
                    contentHTML += '<ul>' + q.lua_chon.map(c => `<li ${q.dap_an_dung.includes(c) ? 'style="color:green;font-weight:bold;"' : ''}>${c}</li>`).join('') + '</ul>';
                } else {
                    contentHTML += `<p><em>ƒê√°p √°n: ${q.dap_an_dung.join(', ')}</em> ‚úÖ</p>`;
                }
                div.innerHTML = contentHTML;
                fragment.appendChild(div);
            });
            modalContent.appendChild(fragment);
            startBtn.style.display = 'inline-block';
            modal.style.display = 'block';
        }

        function viewQuiz(qid) {
            showContent(qid);
        }

        function closeModal() {
            document.getElementById('contentModal').style.display = 'none';
            document.getElementById('startFromModalBtn').style.display = 'none';
        }

        function deleteQuizFromModal() {
            if (!currentModalQuiz) return;
            const qid = Object.keys(getSavedQuizzes()).find(key => JSON.stringify(getSavedQuizzes()[key]) === JSON.stringify(currentModalQuiz));
            if (qid && confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b√†i thi "${qid}" kh√¥ng?`)) {
                showLoading(true);
                setTimeout(async () => {
                    const quizzes = getSavedQuizzes();
                    delete quizzes[qid];
                    const success = await setSavedQuizzes(quizzes);
                    if (success) {
                        selectedQuizzes.delete(qid);
                        const existingBox = document.getElementById(`box-${qid}`);
                        if (existingBox) existingBox.remove();
                        const questionBox = document.getElementById('questionBox');
                        if (questionBox.children.length === 0) questionBox.classList.add('hidden');
                        debouncedRenderSavedQuizzesList();
                        updateStartButton();
                        closeModal();
                        alert(`ƒê√£ x√≥a b√†i thi "${qid}"!`);
                    }
                    showLoading(false);
                }, 0);
            }
        }

        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');
        const questionBox = document.getElementById('questionBox');
        let sidebarVisible = true;

        function toggleSidebar(show) {
            sidebarVisible = show;
            if (show) {
                sidebar.style.transform = "translateX(0)";
                mainContent.classList.remove("full");
                mainContent.classList.add("with-sidebar");
            } else {
                sidebar.style.transform = "translateX(-100%)";
                mainContent.classList.remove("with-sidebar");
                mainContent.classList.add("full");
            }
        }

        const historySidebar = document.getElementById('history-sidebar');
        const historyMainContent = document.getElementById('history-mainContent');
        let historySidebarVisible = true;

        function toggleHistorySidebar(show) {
            historySidebarVisible = show;
            if (show) {
                historySidebar.style.transform = "translateX(0)";
                historyMainContent.classList.remove("full");
                historyMainContent.classList.add("with-sidebar");
            } else {
                historySidebar.style.transform = "translateX(-100%)";
                historyMainContent.classList.remove("with-sidebar");
                historyMainContent.classList.add("full");
            }
        }

        let startX = 0;
        document.addEventListener("touchstart", (e) => {
            startX = e.touches[0].clientX;
        });
        document.addEventListener("touchend", (e) => {
            const endX = e.changedTouches[0].clientX;
            const diff = endX - startX;
            const activeScreen = document.querySelector('.screen.active');
            if (activeScreen.id === 'saved-list-screen') {
                if (diff < -50 && sidebarVisible) toggleSidebar(false);
                if (diff > 50 && !sidebarVisible) toggleSidebar(true);
            } else if (activeScreen.id === 'history-list-screen') {
                if (diff < -50 && historySidebarVisible) toggleHistorySidebar(false);
                if (diff > 50 && !historySidebarVisible) toggleHistorySidebar(true);
            }
        });

        function saveHistory(answers, score, total, isComplete, date = new Date().toLocaleString('vi-VN')) {
            let history = getQuizHistory();
            const entry = {
                id: Date.now(),
                quiz: currentQuiz,
                answers,
                score,
                total,
                isComplete,
                date
            };
            history.unshift(entry); 
            if (history.length > 20) history.pop(); 
            setQuizHistory(history);
        }

        const debouncedRenderHistoryList = debounce(() => {
            const container = document.getElementById('history-list');
            container.innerHTML = '';
            const history = getQuizHistory();

            if (history.length === 0) {
                container.innerHTML = '<p class="text-gray-500">Ch∆∞a c√≥ l·ªãch s·ª≠ l√†m b√†i.</p>';
                return;
            }

            const fragment = document.createDocumentFragment();
            history.forEach((entry, index) => {
                const btn = document.createElement('div');
                const originalColor = index % 3 === 0 ? 'blue' : index % 3 === 1 ? 'green' : 'purple';
                btn.className = `question-btn px-4 py-2 bg-${originalColor}-500 text-white rounded-full cursor-pointer`;
                btn.dataset.id = entry.id;
                btn.dataset.originalClass = btn.className;
                btn.dataset.content = `K·∫øt qu·∫£ l√†m b√†i ng√†y ${entry.date} (ƒêi·ªÉm: ${entry.score}/${entry.total})`;
                btn.textContent = `${entry.date}`;
                btn.onclick = () => {
                    const hid = btn.dataset.id;
                    const existing = document.getElementById(`history-box-${hid}`);
                    if (existing) {
                        existing.remove();
                        btn.className = btn.dataset.originalClass;
                    } else {
                        const div = document.createElement("div");
                        div.id = `history-box-${hid}`;
                        div.className = "p-3 border rounded bg-gray-50";
                        div.innerHTML = `<p><span class="cursor-pointer text-blue-500" onclick="showHistoryContent('${hid}')">${btn.dataset.content}</span></p>`;
                        document.getElementById('history-questionBox').appendChild(div);
                        document.getElementById('history-questionBox').classList.remove("hidden");
                        btn.className = btn.className.replace(`${originalColor}-500`, 'gray-500');
                    }
                    if (document.getElementById('history-questionBox').children.length === 0) {
                        document.getElementById('history-questionBox').classList.add("hidden");
                    }
                };
                fragment.appendChild(btn);
            });
            container.appendChild(fragment);
        }, 100);

        function showHistoryContent(hid) {
            const history = getQuizHistory();
            currentModalHistory = history.find(entry => entry.id == hid);
            if (!currentModalHistory) return;
            const modal = document.getElementById('history-contentModal');
            const modalTitle = document.getElementById('history-modalTitle');
            const modalContent = document.getElementById('history-modalContent');

            modalTitle.textContent = `L·ªãch s·ª≠ l√†m b√†i: ${currentModalHistory.date}`;
            modalContent.innerHTML = `<h4>ƒêi·ªÉm: ${currentModalHistory.score}/${currentModalHistory.total}</h4>`;
            const fragment = document.createDocumentFragment();
            currentModalHistory.quiz.forEach((q, index) => {
                const userAnswerEntry = currentModalHistory.answers.find(a => {
                    const originalQuestion = currentModalHistory.quiz[a.questionIndex]; 
                    return originalQuestion && originalQuestion.cau_hoi === q.cau_hoi;
                }) || { selected: [], isCorrect: false };

                const div = document.createElement('div');
                div.style.cssText = 'margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px solid #eee;';
                let contentHTML = `<p><strong>C√¢u ${index + 1}:</strong> ${q.cau_hoi || 'N·ªôi dung kh√¥ng x√°c ƒë·ªãnh'}</p>`;
                if (q.lua_chon.length > 0) {
                    contentHTML += '<ul>' + q.lua_chon.map(c => `<li style="color:${q.dap_an_dung.includes(c) ? 'green' : 'black'}; font-weight:${q.dap_an_dung.includes(c) ? 'bold' : 'normal'};">${c}</li>`).join('') + '</ul>';
                }
                contentHTML += `<p>C√¢u tr·∫£ l·ªùi c·ªßa b·∫°n: <strong>${userAnswerEntry.selected.join(', ') || 'Ch∆∞a tr·∫£ l·ªùi'}</strong> - <strong style="color:${userAnswerEntry.isCorrect ? 'green' : 'red'};">${userAnswerEntry.isCorrect ? 'ƒê√∫ng' : 'Sai'}</strong></p>`;
                if (!userAnswerEntry.isCorrect) {
                    contentHTML += `<p style="color: green;"><em>ƒê√°p √°n ƒë√∫ng: ${q.dap_an_dung.join(', ')}</em></p>`;
                }
                div.innerHTML = contentHTML;
                fragment.appendChild(div);
            });
            modalContent.appendChild(fragment);
            modal.style.display = 'block';
        }

        function closeHistoryModal() {
            document.getElementById('history-contentModal').style.display = 'none';
        }

        function deleteHistoryFromModal() {
            if (!currentModalHistory) return;
            const hid = currentModalHistory.id;
            if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a l·ªãch s·ª≠ n√†y kh√¥ng?`)) {
                showLoading(true);
                setTimeout(async () => {
                    let history = getQuizHistory();
                    history = history.filter(entry => entry.id !== hid);
                    const success = await setQuizHistory(history);
                    if (success) {
                        const existingBox = document.getElementById(`history-box-${hid}`);
                        if (existingBox) existingBox.remove();
                        const historyQuestionBox = document.getElementById('history-questionBox');
                        if (historyQuestionBox.children.length === 0) historyQuestionBox.classList.add('hidden');
                        debouncedRenderHistoryList();
                        closeHistoryModal();
                        alert('ƒê√£ x√≥a l·ªãch s·ª≠!');
                    }
                    showLoading(false);
                }, 0);
            }
        }

        window.onpopstate = function(event) {
            isPopping = true;
            if (isQuizStarted) {
                if (confirm('B·∫°n c√≥ mu·ªën quay l·∫°i kh√¥ng? N·∫øu c√≥ s·∫Ω coi nh∆∞ n·ªôp b√†i s·ªõm.')) {
                    showResults();
                    showScreen('home-screen');
                    history.replaceState({ screen: 'home-screen' }, '');
                } else {
                    history.pushState({ screen: 'quiz-section' }, '');
                }
            } else {
                const targetScreen = event.state && event.state.screen ? event.state.screen : 'home-screen';
                showScreen(targetScreen);
            }
            isPopping = false;
        };

        // Web Worker ƒë·ªÉ x·ª≠ l√Ω DOCX
        const docxWorkerCode = `
            self.addEventListener('message', async function(e) {
                const { arrayBuffer } = e.data;
                importScripts('https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.8.0/mammoth.browser.min.js');
                try {
                    const result = await mammoth.extractRawText({ arrayBuffer });
                    self.postMessage({ success: true, value: result.value });
                } catch (err) {
                    self.postMessage({ success: false, error: err.message });
                }
            });
        `;

        const docxWorkerBlob = new Blob([docxWorkerCode], { type: 'application/javascript' });
        const docxWorkerURL = URL.createObjectURL(docxWorkerBlob);
        const docxWorker = new Worker(docxWorkerURL);

        document.getElementById('docx-upload').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                showLoading(true);
                const reader = new FileReader();
                reader.onload = function(e) {
                    docxWorker.postMessage({ arrayBuffer: e.target.result });
                };
                docxWorker.onmessage = function(e) {
                    if (e.data.success) {
                        document.getElementById('manual-input').value = e.data.value;
                        alert('ƒê√£ t·∫£i n·ªôi dung t·ª´ file DOCX!');
                    } else {
                        console.error(e.data.error);
                        alert('L·ªói khi ƒë·ªçc file DOCX!');
                    }
                    showLoading(false);
                };
                reader.readAsArrayBuffer(file);
            }
        });

        // Kh·ªüi t·∫°o ·ª©ng d·ª•ng
        showScreen('home-screen');
    </script>
</body>
</html>
